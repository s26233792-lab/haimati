<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理后台 - AI肖像馆</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background: #f8fafc;
            padding: 20px;
        }
        .stats-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .stats-number {
            font-size: 32px;
            font-weight: 700;
            color: #6366f1;
        }
        .code-table {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        .table-section {
            margin-bottom: 30px;
        }
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #334155;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .badge-new {
            background: #10b981;
        }
        .badge-used {
            background: #f59e0b;
        }
        .select-all-checkbox {
            transform: scale(1.2);
        }
        .batch-actions {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 15px 25px;
            border-radius: 50px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            gap: 10px;
        }
        .batch-actions.show {
            display: flex;
        }
        .selected-count {
            background: #6366f1;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
        }
        /* 移动端响应式 - 批量操作栏 */
        @media (max-width: 576px) {
            .batch-actions {
                width: 90%;
                flex-wrap: wrap;
                justify-content: center;
                padding: 12px 16px;
            }

            .batch-actions .btn {
                font-size: 12px;
                padding: 6px 10px;
            }

            .selected-count {
                font-size: 12px;
                padding: 4px 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="bi bi-shield-lock"></i> AI肖像馆 - 管理后台</h1>
            <div>
                <a href="/admin/logout" class="btn btn-outline-danger me-2">
                    <i class="bi bi-box-arrow-right"></i> 退出登录
                </a>
                <a href="/" class="btn btn-outline-secondary">
                    <i class="bi bi-house"></i> 返回首页
                </a>
            </div>
        </div>

        <!-- 统计卡片 -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number" id="totalCodes">{{ codes|length }}</div>
                    <div class="text-muted">总验证码数</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number text-success" id="newCodes">
                        {{ stats.new }}
                    </div>
                    <div class="text-muted">新验证码（未使用）</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number text-warning" id="usedCodes">
                        {{ stats.used }}
                    </div>
                    <div class="text-muted">已使用验证码</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number" id="totalUses">
                        {{ stats.total_uses }}
                    </div>
                    <div class="text-muted">总使用次数</div>
                </div>
            </div>
        </div>

        <!-- 操作按钮 -->
        <div class="row mb-4">
            <div class="col-md-12 d-flex flex-wrap gap-2">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#generateModal">
                    <i class="bi bi-plus-circle"></i> 生成新验证码
                </button>
                <button class="btn btn-success" onclick="copyAllNewCodes()">
                    <i class="bi bi-clipboard"></i> 复制所有新验证码
                </button>
                <div class="dropdown">
                    <button class="btn btn-outline-success dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="bi bi-download"></i> 导出验证码
                    </button>
                    <ul class="dropdown-menu">
                        <li><h6 class="dropdown-header">导出活跃验证码</h6></li>
                        <li><a class="dropdown-item" href="/admin/export_codes">
                            <i class="bi bi-file-text"></i> 导出全部 (TXT)
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="exportSelectedCodes('txt'); return false;">
                            <i class="bi bi-check-square"></i> 导出选中 (TXT)
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="exportAllCodes('csv'); return false;">
                            <i class="bi bi-file-earmark-spreadsheet"></i> 导出全部 (CSV)
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="exportSelectedCodes('csv'); return false;">
                            <i class="bi bi-file-earmark-spreadsheet"></i> 导出选中 (CSV)
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="/admin/export_security_logs">
                            <i class="bi bi-shield-check"></i> 导出安全日志
                        </a></li>
                    </ul>
                </div>
                <button class="btn btn-outline-primary" onclick="invertSelection()">
                    <i class="bi bi-arrow-left-right"></i> 反选
                </button>
                <button class="btn btn-outline-secondary" onclick="selectByCondition('unused')">
                    <i class="bi bi-star"></i> 选未使用
                </button>
                <button class="btn btn-outline-secondary" onclick="selectByCondition('exhausted')">
                    <i class="bi bi-x-circle"></i> 选已用完
                </button>
            </div>
        </div>

        <!-- 新验证码列表 -->
        <div class="table-section">
            <div class="section-title">
                <i class="bi bi-star-fill text-success"></i>
                新验证码（未使用）
                <span class="badge bg-success">{{ stats.new }}</span>
            </div>
            <div class="code-table">
                <table class="table table-striped mb-0">
                    <thead class="table-success">
                        <tr>
                            <th width="50">
                                <input type="checkbox" class="form-check-input select-all-checkbox"
                                       onchange="toggleSelectAll('new', this.checked)">
                            </th>
                            <th>验证码</th>
                            <th>最大使用次数</th>
                            <th>已使用次数</th>
                            <th>剩余次数</th>
                            <th>状态</th>
                            <th>创建时间</th>
                        </tr>
                    </thead>
                    <tbody id="newCodesBody">
                        {% for code in codes %}
                        {% if code.used_count == 0 %}
                        <tr data-code="{{ code.code }}" data-section="new">
                            <td>
                                <input type="checkbox" class="form-check-input code-checkbox"
                                       value="{{ code.code }}" onchange="updateBatchActions()">
                            </td>
                            <td><code>{{ code.code }}</code></td>
                            <td>{{ code.max_uses }}</td>
                            <td>{{ code.used_count }}</td>
                            <td>{{ code.max_uses - code.used_count }}</td>
                            <td>
                                {% if code.status == 'active' %}
                                <span class="badge bg-success">活跃</span>
                                {% else %}
                                <span class="badge bg-secondary">已用完</span>
                                {% endif %}
                            </td>
                            <td>{{ code.created_at }}</td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                        {% if stats.new == 0 %}
                        <tr>
                            <td colspan="7" class="text-center text-muted py-4">暂无新验证码</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 已使用验证码列表 -->
        <div class="table-section">
            <div class="section-title">
                <i class="bi bi-recycle text-warning"></i>
                已使用验证码
                <span class="badge bg-warning">{{ stats.used }}</span>
            </div>
            <div class="code-table">
                <table class="table table-striped mb-0">
                    <thead class="table-warning">
                        <tr>
                            <th width="50">
                                <input type="checkbox" class="form-check-input select-all-checkbox"
                                       onchange="toggleSelectAll('used', this.checked)">
                            </th>
                            <th>验证码</th>
                            <th>最大使用次数</th>
                            <th>已使用次数</th>
                            <th>剩余次数</th>
                            <th>状态</th>
                            <th>创建时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="usedCodesBody">
                        {% for code in codes %}
                        {% if code.used_count > 0 %}
                        <tr data-code="{{ code.code }}" data-section="used">
                            <td>
                                <input type="checkbox" class="form-check-input code-checkbox"
                                       value="{{ code.code }}" onchange="updateBatchActions()">
                            </td>
                            <td><code>{{ code.code }}</code></td>
                            <td>{{ code.max_uses }}</td>
                            <td>{{ code.used_count }}</td>
                            <td>{{ code.max_uses - code.used_count }}</td>
                            <td>
                                {% if code.status == 'active' %}
                                <span class="badge bg-success">活跃</span>
                                {% else %}
                                <span class="badge bg-secondary">已用完</span>
                                {% endif %}
                            </td>
                            <td>{{ code.created_at }}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="resetCode('{{ code.code }}')">
                                    <i class="bi bi-arrow-clockwise"></i> 重置
                                </button>
                            </td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                        {% if stats.used == 0 %}
                        <tr>
                            <td colspan="8" class="text-center text-muted py-4">暂无已使用验证码</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 批量操作栏 -->
    <div class="batch-actions" id="batchActions">
        <span class="selected-count">已选 <span id="selectedCount">0</span> 个</span>
        <button class="btn btn-sm btn-primary" onclick="batchCopy()">
            <i class="bi bi-clipboard"></i> 复制
        </button>
        <button class="btn btn-sm btn-success" onclick="batchCopyWithFormat()">
            <i class="bi bi-clipboard-data"></i> 复制(带信息)
        </button>
        <button class="btn btn-sm btn-info" onclick="batchReset()">
            <i class="bi bi-arrow-clockwise"></i> 重置
        </button>
        <button class="btn btn-sm btn-danger" onclick="confirmBatchDelete()">
            <i class="bi bi-trash"></i> 删除
        </button>
        <button class="btn btn-sm btn-secondary" onclick="batchDisable()">
            <i class="bi bi-x-circle"></i> 禁用
        </button>
        <button class="btn btn-sm btn-success" onclick="batchEnable()">
            <i class="bi bi-check-circle"></i> 启用
        </button>
        <button class="btn btn-sm btn-outline-secondary" onclick="clearSelection()">
            <i class="bi bi-x"></i> 取消选择
        </button>
    </div>

    <!-- 生成验证码模态框 -->
    <div class="modal fade" id="generateModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-plus-circle"></i> 批量生成验证码</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- 套餐选择 -->
                    <div class="mb-3">
                        <label class="form-label">选择套餐</label>
                        <select id="genPackage" class="form-select" onchange="updatePackageInfo()">
                            <option value="1">体验版 (1次) - ¥9.9</option>
                            <option value="3" selected>基础版 (3次) - ¥19.9</option>
                            <option value="5">标准版 (5次) - ¥29.9</option>
                            <option value="8">专业版 (8次) - ¥39.9</option>
                            <option value="30">无限版 (30次) - ¥99.9</option>
                            <option value="custom">自定义次数</option>
                        </select>
                    </div>

                    <!-- 自定义次数（仅当选择"自定义"时显示） -->
                    <div class="mb-3" id="customUsesDiv" style="display: none;">
                        <label class="form-label">自定义次数</label>
                        <input type="number" id="genUses" class="form-control" value="3" min="1" max="100">
                    </div>

                    <!-- 生成数量 -->
                    <div class="mb-3">
                        <label class="form-label">生成数量</label>
                        <input type="number" id="genCount" class="form-control" value="10" min="1" max="1000">
                    </div>

                    <!-- 预览信息 -->
                    <div class="alert alert-info">
                        <strong>预览：</strong>
                        <span id="previewInfo">将生成 10 个 基础版 验证码，每个可使用 3 次</span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="generateCodes()">
                        <i class="bi bi-check-lg"></i> 生成
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 确认操作模态框 -->
    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmModalTitle">确认操作</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="confirmModalBody">
                    确定要执行此操作吗？
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger" id="confirmModalButton">确定</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let selectedCodes = new Set();

        // 套餐信息
        const packages = {
            '1': { name: '体验版', uses: 1, price: 9.9 },
            '3': { name: '基础版', uses: 3, price: 19.9 },
            '5': { name: '标准版', uses: 5, price: 29.9 },
            '8': { name: '专业版', uses: 8, price: 39.9 },
            '30': { name: '无限版', uses: 30, price: 99.9 },
            'custom': { name: '自定义', uses: 0, price: 0 }
        };

        function toggleSelectAll(section, checked) {
            const checkboxes = document.querySelectorAll(`input[data-section="${section}"].code-checkbox`);
            checkboxes.forEach(cb => {
                cb.checked = checked;
                if (checked) {
                    selectedCodes.add(cb.value);
                } else {
                    selectedCodes.delete(cb.value);
                }
            });
            updateBatchActions();
        }

        function updateBatchActions() {
            const checkboxes = document.querySelectorAll('.code-checkbox:checked');
            selectedCodes.clear();
            checkboxes.forEach(cb => selectedCodes.add(cb.value));

            const batchActions = document.getElementById('batchActions');
            const selectedCount = document.getElementById('selectedCount');

            if (selectedCodes.size > 0) {
                batchActions.classList.add('show');
                selectedCount.textContent = selectedCodes.size;
            } else {
                batchActions.classList.remove('show');
            }
        }

        function clearSelection() {
            document.querySelectorAll('.code-checkbox').forEach(cb => cb.checked = false);
            document.querySelectorAll('.select-all-checkbox').forEach(cb => cb.checked = false);
            selectedCodes.clear();
            updateBatchActions();
        }

        // 反选
        function invertSelection() {
            const checkboxes = document.querySelectorAll('.code-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = !cb.checked;
                if (cb.checked) {
                    selectedCodes.add(cb.value);
                } else {
                    selectedCodes.delete(cb.value);
                }
            });
            updateBatchActions();
        }

        // 按条件选择
        function selectByCondition(condition) {
            const checkboxes = document.querySelectorAll('.code-checkbox');
            checkboxes.forEach(cb => {
                const row = cb.closest('tr');
                const usedCount = parseInt(row.cells[3].textContent);
                const maxUses = parseInt(row.cells[2].textContent);

                let shouldSelect = false;
                if (condition === 'unused') {
                    shouldSelect = usedCount === 0;
                } else if (condition === 'exhausted') {
                    shouldSelect = usedCount >= maxUses;
                }

                cb.checked = shouldSelect;
                if (shouldSelect) {
                    selectedCodes.add(cb.value);
                } else {
                    selectedCodes.delete(cb.value);
                }
            });
            updateBatchActions();
            showToast(`已选择 ${selectedCodes.size} 个验证码`);
        }

        // 导出选中的验证码
        async function exportSelectedCodes(format = 'txt') {
            if (selectedCodes.size === 0) {
                showToast('请先选择要导出的验证码', 'warning');
                return;
            }

            if (format === 'csv') {
                // 导出 CSV 格式（带详细信息）
                let csv = '验证码,最大使用次数,已使用次数,剩余次数,状态,创建时间\n';
                const checkboxes = document.querySelectorAll('.code-checkbox:checked');
                checkboxes.forEach(cb => {
                    const row = cb.closest('tr');
                    const code = row.querySelector('code').textContent;
                    const maxUses = row.cells[2].textContent;
                    const usedCount = row.cells[3].textContent;
                    const remaining = row.cells[4].textContent;
                    const status = row.cells[5].textContent.trim();
                    const createdAt = row.cells[6].textContent;
                    csv += `${code},${maxUses},${usedCount},${remaining},${status},${createdAt}\n`;
                });
                downloadFile(csv, 'selected_codes.csv', 'text/csv');
            } else {
                // 导出 TXT 格式
                const codes = Array.from(selectedCodes).join('\n');
                downloadFile(codes, 'selected_codes.txt', 'text/plain');
            }
            showToast(`成功导出 ${selectedCodes.size} 个验证码`);
        }

        // 导出所有验证码（CSV 格式）
        async function exportAllCodes(format = 'csv') {
            try {
                const response = await fetch('/admin/export_all_csv');
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `all_codes_${format}.${format}`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    showToast('成功导出所有验证码');
                }
            } catch (err) {
                showToast('导出失败', 'danger');
            }
        }

        // 下载文件辅助函数
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // 批量复制验证码（纯文本，每行一个）
        async function batchCopy() {
            if (selectedCodes.size === 0) {
                alert('请先选择要复制的验证码');
                return;
            }

            const codes = Array.from(selectedCodes).join('\n');

            try {
                await navigator.clipboard.writeText(codes);
                showToast(`成功复制 ${selectedCodes.size} 个验证码到剪贴板`);
            } catch (err) {
                // 降级方案：使用传统方法
                const textarea = document.createElement('textarea');
                textarea.value = codes;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    showToast(`成功复制 ${selectedCodes.size} 个验证码到剪贴板`);
                } catch (e) {
                    alert('复制失败，请手动复制');
                }
                document.body.removeChild(textarea);
            }
        }

        // 批量复制验证码（带详细信息的格式）
        async function batchCopyWithFormat() {
            if (selectedCodes.size === 0) {
                alert('请先选择要复制的验证码');
                return;
            }

            // 获取选中行的详细信息
            const formattedCodes = [];
            const checkboxes = document.querySelectorAll('.code-checkbox:checked');

            checkboxes.forEach(cb => {
                const row = cb.closest('tr');
                const code = row.querySelector('code').textContent;
                const maxUses = row.cells[2].textContent;
                const usedCount = row.cells[3].textContent;
                const remaining = row.cells[4].textContent;
                formattedCodes.push(`${code} (剩余:${remaining}/${maxUses})`);
            });

            const text = formattedCodes.join('\n');

            try {
                await navigator.clipboard.writeText(text);
                showToast(`成功复制 ${selectedCodes.size} 个验证码（含详细信息）`);
            } catch (err) {
                // 降级方案
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    showToast(`成功复制 ${selectedCodes.size} 个验证码（含详细信息）`);
                } catch (e) {
                    alert('复制失败，请手动复制');
                }
                document.body.removeChild(textarea);
            }
        }

        // 显示提示消息
        function showToast(message, type = 'success') {
            const icons = {
                'success': 'bi-check-circle',
                'warning': 'bi-exclamation-circle',
                'danger': 'bi-x-circle',
                'info': 'bi-info-circle'
            };
            const alertClass = {
                'success': 'alert-success',
                'warning': 'alert-warning',
                'danger': 'alert-danger',
                'info': 'alert-info'
            };

            // 创建toast元素
            const toast = document.createElement('div');
            toast.className = `alert ${alertClass[type]} position-fixed`;
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 250px; animation: slideIn 0.3s ease;';
            toast.innerHTML = `<i class="bi ${icons[type]}"></i> ${message}`;

            // 添加样式
            if (!document.getElementById('toast-style')) {
                const style = document.createElement('style');
                style.id = 'toast-style';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }

            document.body.appendChild(toast);

            // 3秒后自动消失
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // 确认操作辅助函数
        function confirmAction(title, message, onConfirm) {
            const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
            document.getElementById('confirmModalTitle').textContent = title;
            document.getElementById('confirmModalBody').textContent = message;

            const confirmBtn = document.getElementById('confirmModalButton');
            confirmBtn.onclick = function() {
                modal.hide();
                onConfirm();
            };

            modal.show();
        }

        // 复制所有新验证码（未使用的）
        async function copyAllNewCodes() {
            const newCodeCheckboxes = document.querySelectorAll('#newCodesBody .code-checkbox');

            if (newCodeCheckboxes.length === 0) {
                alert('暂无新验证码可复制');
                return;
            }

            const codes = [];
            newCodeCheckboxes.forEach(cb => {
                codes.push(cb.value);
            });

            const text = codes.join('\n');

            try {
                await navigator.clipboard.writeText(text);
                showToast(`成功复制 ${codes.length} 个新验证码到剪贴板`);
            } catch (err) {
                // 降级方案
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    showToast(`成功复制 ${codes.length} 个新验证码到剪贴板`);
                } catch (e) {
                    alert('复制失败，请手动复制');
                }
                document.body.removeChild(textarea);
            }
        }

        // 批量删除（带确认）
        function confirmBatchDelete() {
            if (selectedCodes.size === 0) {
                showToast('请先选择要删除的验证码', 'warning');
                return;
            }
            confirmAction(
                '确认删除',
                `确定要删除选中的 ${selectedCodes.size} 个验证码吗？此操作不可恢复！`,
                async () => {
                    const response = await fetch('/admin/batch_delete', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ codes: Array.from(selectedCodes) })
                    });

                    const data = await response.json();
                    if (data.success) {
                        showToast(`成功删除 ${data.deleted} 个验证码`);
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        showToast('删除失败：' + data.message, 'danger');
                    }
                }
            );
        }

        async function batchDelete() {
            confirmBatchDelete();
        }

        // 批量重置
        function batchReset() {
            if (selectedCodes.size === 0) {
                showToast('请先选择要重置的验证码', 'warning');
                return;
            }
            confirmAction(
                '确认重置',
                `确定要重置选中的 ${selectedCodes.size} 个验证码的使用次数吗？`,
                async () => {
                    const response = await fetch('/admin/batch_reset', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ codes: Array.from(selectedCodes) })
                    });

                    const data = await response.json();
                    if (data.success) {
                        showToast(`成功重置 ${data.reset} 个验证码`);
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        showToast('操作失败：' + data.message, 'danger');
                    }
                }
            );
        }

        async function batchDisable() {
            if (selectedCodes.size === 0) {
                showToast('请先选择要禁用的验证码', 'warning');
                return;
            }

            const response = await fetch('/admin/batch_update_status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ codes: Array.from(selectedCodes), status: 'inactive' })
            });

            const data = await response.json();
            if (data.success) {
                showToast(`成功禁用 ${data.updated} 个验证码`);
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('操作失败：' + data.message, 'danger');
            }
        }

        async function batchEnable() {
            if (selectedCodes.size === 0) {
                showToast('请先选择要启用的验证码', 'warning');
                return;
            }

            const response = await fetch('/admin/batch_update_status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ codes: Array.from(selectedCodes), status: 'active' })
            });

            const data = await response.json();
            if (data.success) {
                showToast(`成功启用 ${data.updated} 个验证码`);
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('操作失败：' + data.message, 'danger');
            }
        }

        async function resetCode(code) {
            confirmAction(
                '确认重置',
                `确定要重置验证码 ${code} 的使用次数吗？`,
                async () => {
                    const response = await fetch('/admin/reset_code', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ code })
                    });

                    const data = await response.json();
                    if (data.success) {
                        showToast('验证码已重置');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        showToast('重置失败：' + data.message, 'danger');
                    }
                }
            );
        }

        // 套餐选择变化时更新显示
        function updatePackageInfo() {
            const packageValue = document.getElementById('genPackage').value;
            const customUsesDiv = document.getElementById('customUsesDiv');

            if (packageValue === 'custom') {
                customUsesDiv.style.display = 'block';
                document.getElementById('genUses').disabled = false;
            } else {
                customUsesDiv.style.display = 'none';
                document.getElementById('genUses').disabled = true;
            }
            updatePreview();
        }

        // 更新预览信息
        function updatePreview() {
            const packageValue = document.getElementById('genPackage').value;
            const count = document.getElementById('genCount').value;
            let uses, packageName;

            if (packageValue === 'custom') {
                uses = document.getElementById('genUses').value;
                packageName = '自定义';
            } else {
                const pkg = packages[packageValue];
                uses = pkg.uses;
                packageName = pkg.name;
            }

            document.getElementById('previewInfo').textContent =
                `将生成 ${count} 个 ${packageName} 验证码，每个可使用 ${uses} 次`;
        }

        // 生成验证码
        async function generateCodes() {
            const packageValue = document.getElementById('genPackage').value;
            const count = document.getElementById('genCount').value;
            let uses;

            if (packageValue === 'custom') {
                uses = document.getElementById('genUses').value;
            } else {
                uses = packageValue;
            }

            const response = await fetch('/admin/generate_codes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    count: parseInt(count),
                    max_uses: parseInt(uses)
                })
            });

            const data = await response.json();

            if (data.success) {
                alert(`成功生成 ${data.count} 个验证码！\n\n前5个验证码:\n${data.codes.slice(0, 5).join('\n')}`);
                location.reload();
            } else {
                alert('生成失败');
            }
        }

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            updatePackageInfo();

            // 监听输入变化
            document.getElementById('genPackage').addEventListener('change', updatePackageInfo);
            document.getElementById('genCount').addEventListener('input', updatePreview);
            document.getElementById('genUses').addEventListener('input', updatePreview);
        });
    </script>
</body>
</html>
